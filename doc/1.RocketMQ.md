## Apache RocketMQ ç®€ä»‹

**Apache RocketMQ** æ˜¯ä¸€æ¬¾ç”±é˜¿é‡Œå·´å·´å¼€æºã€åæèµ ç»™ Apache åŸºé‡‘ä¼šçš„ **åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶**ï¼Œå…·æœ‰**é«˜ååã€ä½å»¶è¿Ÿã€é«˜å¯ç”¨ã€é«˜å¯é ã€é‡‘èçº§ä¸€è‡´æ€§**ç­‰ç‰¹æ€§ï¼Œå¹¿æ³›åº”ç”¨äºç”µå•†ã€é‡‘èã€ç‰©æµã€ç‰©è”ç½‘ç­‰å¯¹æ¶ˆæ¯å¯é æ€§è¦æ±‚æé«˜çš„åœºæ™¯ã€‚

ğŸ“š å®˜ç½‘ï¼šhttps://rocketmq.apache.org
ğŸ“˜ GitHubï¼šhttps://github.com/apache/rocketmq
ğŸ“˜ ä¸­æ–‡æ–‡æ¡£ï¼šhttps://rocketmq.apache.org/zh/docs/

------

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§                | è¯´æ˜                                                        |
| ------------------- | ----------------------------------------------------------- |
| **é«˜åå & ä½å»¶è¿Ÿ** | å•æœºå¯æ”¯æ’‘ **10ä¸‡+ TPS**ï¼Œæ¯«ç§’çº§æŠ•é€’å»¶è¿Ÿ                    |
| **é‡‘èçº§å¯é æ€§**    | æ”¯æŒåŒæ­¥åˆ·ç›˜ + ä¸»ä»åŒæ­¥ï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ï¼ˆå¦‚æ”¯ä»˜å®äº¤æ˜“æ¶ˆæ¯ï¼‰ |
| **é¡ºåºæ¶ˆæ¯**        | ä¸¥æ ¼ä¿è¯ **å…¨å±€æˆ–åˆ†åŒºé¡ºåº**ï¼ˆå¦‚è®¢å•çŠ¶æ€å˜æ›´ï¼‰               |
| **äº‹åŠ¡æ¶ˆæ¯**        | æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆâ€œåŠæ¶ˆæ¯â€æœºåˆ¶ï¼‰ï¼Œå®ç°æœ€ç»ˆä¸€è‡´æ€§              |
| **æ¶ˆæ¯è½¨è¿¹**        | å¯è¿½è¸ªæ¶ˆæ¯ä»ç”Ÿäº§åˆ°æ¶ˆè´¹çš„å…¨é“¾è·¯                              |
| **å®šæ—¶/å»¶è¿Ÿæ¶ˆæ¯**   | æ”¯æŒ **18 ä¸ªç­‰çº§**çš„å»¶è¿Ÿï¼ˆ1s ~ 2hï¼‰ï¼Œä¹Ÿæ”¯æŒè‡ªå®šä¹‰å®šæ—¶       |
| **æµ·é‡æ¶ˆæ¯å †ç§¯**    | æ”¯æŒ **TB çº§æ¶ˆæ¯å †ç§¯**ï¼Œä¸å½±å“æ€§èƒ½                          |
| **å¤šè¯­è¨€å®¢æˆ·ç«¯**    | å®˜æ–¹æ”¯æŒ Javaã€C++ã€Goã€Pythonã€Node.js ç­‰                  |
| **äº‘åŸç”Ÿæ”¯æŒ**      | æ”¯æŒ Kubernetes éƒ¨ç½²ï¼Œå…¼å®¹é˜¿é‡Œäº‘ RocketMQ å•†ä¸šç‰ˆ            |

------

## ğŸ“¦ æ ¸å¿ƒæ¶æ„ç»„ä»¶

### 1. **NameServerï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰**

- è½»é‡çº§æœåŠ¡å‘ç°ç»„ä»¶ï¼Œç®¡ç† Broker çš„è·¯ç”±ä¿¡æ¯
- æ— çŠ¶æ€ï¼Œæ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼ˆé€šå¸¸ 2 èŠ‚ç‚¹ä»¥ä¸Šï¼‰
- Producer/Consumer é€šè¿‡ NameServer è·å– Broker åœ°å€

### 2. **Brokerï¼ˆæ¶ˆæ¯æœåŠ¡å™¨ï¼‰**

- æ ¸å¿ƒæ•°æ®èŠ‚ç‚¹ï¼Œè´Ÿè´£æ¶ˆæ¯çš„**å­˜å‚¨ã€æŠ•é€’ã€æŸ¥è¯¢**
- åˆ†ä¸º **Master** å’Œ **Slave**ï¼ˆä¸»ä»æ¶æ„ï¼Œæ”¯æŒåŒæ­¥/å¼‚æ­¥å¤åˆ¶ï¼‰
- æ¯ä¸ª Broker å¯åŒ…å«å¤šä¸ª **Topic çš„é˜Ÿåˆ—ï¼ˆMessageQueueï¼‰**

### 3. **Producerï¼ˆç”Ÿäº§è€…ï¼‰**

- å‘é€æ¶ˆæ¯åˆ° Broker
- æ”¯æŒ **åŒæ­¥ã€å¼‚æ­¥ã€å•å‘** ä¸‰ç§å‘é€æ–¹å¼
- è‡ªåŠ¨ä» NameServer è·å–è·¯ç”±ï¼Œè´Ÿè½½å‡è¡¡é€‰æ‹©é˜Ÿåˆ—

### 4. **Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰**

- ä» Broker æ‹‰å–æ¶ˆæ¯
- æ”¯æŒä¸¤ç§æ¶ˆè´¹æ¨¡å¼ï¼š
  - **é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰**ï¼šåŒç»„å†…è´Ÿè½½å‡è¡¡ï¼ˆé»˜è®¤ï¼‰
  - **å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰**ï¼šæ¯æ¡æ¶ˆæ¯è¢«ç»„å†…æ‰€æœ‰æ¶ˆè´¹è€…æ¶ˆè´¹





```mermaid
graph TD
	
	    subgraph "RocketMQ Cluster"
        NS[NameServer <br/>é›†ç¾¤ æ— çŠ¶æ€]
        B1[Broker Master<br/>Queue0, Queue1]
        B2[Broker Slave<br/>Queue0, Queue1]
        B1 -->|å¿ƒè·³ & æ³¨å†Œ| NS
        B2 -->|å¿ƒè·³ & æ³¨å†Œ| NS
        B1 <-->|ä¸»ä»åŒæ­¥| B2
    end

    subgraph "Client Side"
        P[Producer] -->|1.æŸ¥è¯¢è·¯ç”±| NS
        C[Consumer] -->|2.æŸ¥è¯¢è·¯ç”±| NS
        P -->|3.å‘é€æ¶ˆæ¯| B1
        C -->|4.æ‹‰å–æ¶ˆæ¯| B1
    end



    style NS fill:#cff,stroke:#333
    style B1 fill:#cfc,stroke:#333
    style B2 fill:#fcc,stroke:#333
    style P fill:#eee,stroke:#333
    style C fill:#eee,stroke:#333

```

1. **å¯åŠ¨é˜¶æ®µ**ï¼š
   - Broker å¯åŠ¨åï¼Œå‘æ‰€æœ‰ NameServer æ³¨å†Œè‡ªå·±çš„åœ°å€å’Œ Topic è·¯ç”±ä¿¡æ¯ã€‚
   - NameServer ä¿å­˜ Broker åˆ—è¡¨å’Œ Topic â†’ Queue çš„æ˜ å°„ã€‚
2. **ç”Ÿäº§æ¶ˆæ¯**ï¼š
   - Producer å¯åŠ¨æ—¶ä» NameServer æ‹‰å– Topic çš„è·¯ç”±ä¿¡æ¯ï¼ˆåŒ…å« Broker åœ°å€ã€Queue åˆ†å¸ƒï¼‰ã€‚
   - Producer æ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©ä¸€ä¸ª MessageQueueï¼Œç›´æ¥è¿æ¥å¯¹åº” Broker å‘é€æ¶ˆæ¯ã€‚
3. **æ¶ˆè´¹æ¶ˆæ¯**ï¼š
   - Consumer å¯åŠ¨æ—¶åŒæ ·ä» NameServer è·å–è·¯ç”±ä¿¡æ¯ã€‚
   - Consumer å‘ Broker å‘èµ·é•¿è½®è¯¢ï¼ˆPull æ¨¡å¼ï¼‰ï¼Œæ‹‰å–æŒ‡å®š Queue çš„æ¶ˆæ¯ã€‚
   - æ¶ˆè´¹æˆåŠŸåï¼ŒConsumer æäº¤æ¶ˆè´¹ä½ç‚¹ï¼ˆOffsetï¼‰åˆ° Brokerã€‚
4. **é«˜å¯ç”¨ä¿éšœ**ï¼š
   - è‹¥ Master Broker å®•æœºï¼ŒSlave å¯æ¥ç®¡è¯»è¯·æ±‚ï¼ˆå†™éœ€åˆ‡æ¢ï¼‰ã€‚
   - NameServer é›†ç¾¤æ— çŠ¶æ€ï¼Œä»»æ„èŠ‚ç‚¹å®•æœºä¸å½±å“æœåŠ¡ã€‚

> ğŸ’¡ **è¯´æ˜**
>
> - å®é™…éƒ¨ç½²ä¸­ï¼ŒNameServer é€šå¸¸ä¸º 2~3 èŠ‚ç‚¹é›†ç¾¤ã€‚
> - Broker å¯éƒ¨ç½²å¤šç»„ï¼ˆBroker Groupï¼‰ï¼Œæ¯ç»„å« 1 Master + N Slaveã€‚
> - Producer/Consumer **ç›´è¿ Broker**ï¼ŒNameServer ä»…ç”¨äºè·¯ç”±å‘ç°ï¼Œ**ä¸å‚ä¸æ¶ˆæ¯ä¼ è¾“**ï¼Œå› æ­¤æ€§èƒ½æé«˜ã€‚

## ğŸ“Œ æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ             | è¯´æ˜                                                    |
| ---------------- | ------------------------------------------------------- |
| **Topic**        | æ¶ˆæ¯çš„é€»è¾‘åˆ†ç±»ï¼ˆå¦‚ `OrderTopic`, `UserEvent`ï¼‰          |
| **Tag**          | Topic ä¸‹çš„äºŒçº§åˆ†ç±»ï¼Œç”¨äºè¿‡æ»¤ï¼ˆå¦‚ `TagA`, `TagB`ï¼‰       |
| **MessageQueue** | Topic çš„ç‰©ç†åˆ†ç‰‡ï¼Œç±»ä¼¼ Kafka çš„ Partitionï¼Œå®ç°å¹¶è¡Œå¤„ç† |
| **Group**        | Producer Group / Consumer Groupï¼Œç”¨äºæ ‡è¯†åº”ç”¨åˆ†ç»„       |
| **Offset**       | æ¶ˆè´¹è€…åœ¨ MessageQueue ä¸­çš„æ¶ˆè´¹ä½ç½®                      |

> âœ… **Topic + Queue æ¨¡å‹**ï¼š
>  ä¸€ä¸ª Topic è¢«åˆ†ä¸ºå¤šä¸ª MessageQueueï¼Œåˆ†å¸ƒåœ¨ä¸åŒ Broker ä¸Šï¼Œå®ç°æ°´å¹³æ‰©å±•ã€‚

## ğŸ“¦ æ•°æ®å­˜å‚¨ç»“æ„ï¼ˆè¡¥å……ï¼‰

æ¯ä¸ª Broker ä¸Šçš„ Topic è¢«åˆ’åˆ†ä¸ºå¤šä¸ª **MessageQueue**ï¼Œç‰©ç†å­˜å‚¨å¦‚ä¸‹ï¼š

```text
Broker
â”œâ”€â”€ commitlog/                # æ‰€æœ‰æ¶ˆæ¯é¡ºåºå†™å…¥æ­¤æ–‡ä»¶ï¼ˆAppend-onlyï¼‰
â”œâ”€â”€ consumequeue/             # æ¯ä¸ª Queue çš„ç´¢å¼•æ–‡ä»¶ï¼ˆé€»è¾‘é˜Ÿåˆ—ï¼‰
â”‚   â”œâ”€â”€ TopicA/
â”‚   â”‚   â”œâ”€â”€ 0/               # QueueId=0
â”‚   â”‚   â”œâ”€â”€ 1/               # QueueId=1
â”‚   â””â”€â”€ TopicB/
â””â”€â”€ index/                    # æ¶ˆæ¯ç´¢å¼•ï¼ˆç”¨äºæŒ‰ key æŸ¥è¯¢ï¼‰
```

> âœ… **è®¾è®¡ä¼˜åŠ¿**ï¼š
>
> - **CommitLog é¡ºåºå†™**ï¼šæå¤§æå‡ç£ç›˜ I/O æ€§èƒ½
> - **ConsumeQueue è½»é‡ç´¢å¼•**ï¼šå¿«é€Ÿå®šä½æ¶ˆæ¯ä½ç½®
> - **æ¶ˆæ¯ä¸ç´¢å¼•åˆ†ç¦»**ï¼šå…¼é¡¾å†™å…¥æ€§èƒ½ä¸æŸ¥è¯¢æ•ˆç‡

## ğŸŒ é«˜å¯ç”¨æ¶æ„ï¼ˆDledger æ¨¡å¼ï¼‰

```mermaid
graph LR
    P[Producer] --> B1
    P --> B2
    P --> B3

    subgraph "Dledger Group (Raft)"
        B1[Broker Node1<br/>Leader/Follower]
        B2[Broker Node2<br/>Follower]
        B3[Broker Node3<br/>Follower]
        B1 <--> B2
        B2 <--> B3
        B1 <--> B3
    end

    NS[NameServer] <--> B1
    NS <--> B2
    NS <--> B3

```

> âœ… **Dledger ä¼˜åŠ¿**ï¼š
>
> - **è‡ªåŠ¨é€‰ä¸»**ï¼ˆLeader Electionï¼‰
> - å¼ºä¸€è‡´æ€§å¤åˆ¶ï¼ˆQuorum å†™å…¥ï¼‰
> - æ•…éšœè‡ªåŠ¨åˆ‡æ¢ï¼Œæ— éœ€äººå·¥å¹²é¢„

------

## âœ… æ€»ç»“ï¼šRocketMQ æ¶æ„æ ¸å¿ƒæ€æƒ³

| è®¾è®¡åŸåˆ™       | ä½“ç°                                              |
| -------------- | ------------------------------------------------- |
| **å»ä¸­å¿ƒåŒ–**   | NameServer ä»…åšè·¯ç”±ï¼Œä¸å‚ä¸æ¶ˆæ¯æµè½¬               |
| **é«˜æ€§èƒ½å†™å…¥** | CommitLog é¡ºåºå†™ + å¼‚æ­¥åˆ·ç›˜                       |
| **é«˜å¯ç”¨**     | ä¸»ä»å¤åˆ¶ / Dledger è‡ªåŠ¨å®¹ç¾                       |
| **æ°´å¹³æ‰©å±•**   | å¢åŠ  Broker èŠ‚ç‚¹å³å¯æ‰©å®¹ Topic Queue              |
| **è§£è€¦**       | Producer/Consumer é€šè¿‡ NameServer åŠ¨æ€å‘ç° Broker |

------



------

## ğŸ”„ æ¶ˆæ¯ç±»å‹æ”¯æŒ

| ç±»å‹         | è¯´æ˜                           | å…¸å‹åœºæ™¯                       |
| ------------ | ------------------------------ | ------------------------------ |
| **æ™®é€šæ¶ˆæ¯** | æœ€åŸºç¡€çš„æ¶ˆæ¯ç±»å‹               | æ—¥å¿—ã€é€šçŸ¥                     |
| **é¡ºåºæ¶ˆæ¯** | ä¿è¯åŒä¸€ä¸šåŠ¡ ID çš„æ¶ˆæ¯ä¸¥æ ¼æœ‰åº | è®¢å•åˆ›å»º â†’ æ”¯ä»˜ â†’ å‘è´§         |
| **äº‹åŠ¡æ¶ˆæ¯** | â€œåŠæ¶ˆæ¯â€ + æœ¬åœ°äº‹åŠ¡çŠ¶æ€å›æŸ¥    | è·¨ç³»ç»Ÿè½¬è´¦ã€åº“å­˜æ‰£å‡           |
| **å»¶è¿Ÿæ¶ˆæ¯** | æŒ‡å®šå»¶è¿Ÿæ—¶é—´åæŠ•é€’             | è®¢å•è¶…æ—¶å–æ¶ˆã€30åˆ†é’Ÿæœªæ”¯ä»˜æé†’ |
| **æ‰¹é‡æ¶ˆæ¯** | ä¸€æ¬¡å‘é€å¤šæ¡ï¼Œæå‡åå         | æ—¥å¿—æ‰¹é‡ä¸ŠæŠ¥                   |

------

## ğŸ› ï¸ å…¸å‹åº”ç”¨åœºæ™¯

| åœºæ™¯                    | RocketMQ ä¼˜åŠ¿                   |
| ----------------------- | ------------------------------- |
| **ç”µå•†äº¤æ˜“ç³»ç»Ÿ**        | äº‹åŠ¡æ¶ˆæ¯ä¿éšœè®¢å•ä¸åº“å­˜ä¸€è‡´æ€§    |
| **é‡‘èæ”¯ä»˜**            | åŒæ­¥åˆ·ç›˜ + ä¸»ä»æ¶æ„ï¼Œæ¶ˆæ¯é›¶ä¸¢å¤± |
| **å®æ—¶æ•°æ®åŒæ­¥**        | é«˜ååæ”¯æ’‘æµ·é‡æ•°æ®ç®¡é“          |
| **å‰Šå³°å¡«è°·**            | ç§’æ€è¯·æ±‚å…¥é˜Ÿï¼Œåç«¯å¹³ç¨³å¤„ç†      |
| **äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEDAï¼‰** | è§£è€¦å¾®æœåŠ¡ï¼Œé€šè¿‡äº‹ä»¶é€šä¿¡        |
| **IoT è®¾å¤‡ä¸ŠæŠ¥**        | æ”¯æŒæµ·é‡è®¾å¤‡è¿æ¥ä¸æ¶ˆæ¯å †ç§¯      |

------

## âš™ï¸ é«˜çº§èƒ½åŠ›

### 1. **æ¶ˆæ¯é‡è¯• & æ­»ä¿¡é˜Ÿåˆ—**

- æ¶ˆè´¹å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š 16 æ¬¡ï¼‰
- è¶…è¿‡é‡è¯•æ¬¡æ•°è¿›å…¥ **æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰**ï¼Œä¾¿äºäººå·¥å¹²é¢„

### 2. **æ¶ˆæ¯è¿‡æ»¤**

- **Tag è¿‡æ»¤**ï¼šConsumer åªè®¢é˜…ç‰¹å®š Tag
- **SQL è¡¨è¾¾å¼è¿‡æ»¤**ï¼šåŸºäºæ¶ˆæ¯å±æ€§åŠ¨æ€è¿‡æ»¤ï¼ˆå¦‚ `a > 5 AND b = 'X'`ï¼‰

### 3. **ä¸»ä»æ¶æ„ & Dledger**

- ä¼ ç»Ÿä¸»ä»ï¼šå¼‚æ­¥/åŒæ­¥å¤åˆ¶
- **Dledger æ¨¡å¼**ï¼ˆåŸºäº Raftï¼‰ï¼šè‡ªåŠ¨é€‰ä¸»ï¼Œå®ç° **è‡ªåŠ¨æ•…éšœè½¬ç§»**ï¼ˆç±»ä¼¼ Kafka KRaftï¼‰

### 4. **è¿ç»´ç›‘æ§**

- æä¾› **RocketMQ Console**ï¼ˆå¼€æºç®¡ç†ç•Œé¢ï¼‰
- æ”¯æŒ Prometheus + Grafana ç›‘æ§

## âœ… æ€»ç»“

> **RocketMQ æ˜¯ä¸ºâ€œé«˜å¯é ã€å¼ºä¸€è‡´ã€å¤æ‚ä¸šåŠ¡â€è€Œç”Ÿçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå°¤å…¶é€‚åˆé‡‘èçº§åº”ç”¨åœºæ™¯ã€‚**

å®ƒåœ¨ **äº‹åŠ¡æ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯** ç­‰æ–¹é¢æä¾›äº† Kafka å’Œ RabbitMQ éš¾ä»¥æ›¿ä»£çš„èƒ½åŠ›ï¼Œå·²æˆä¸ºå›½å†…äº’è”ç½‘å¤§å‚ï¼ˆé˜¿é‡Œã€è…¾è®¯ã€å­—èŠ‚ç­‰ï¼‰çš„ä¸»æµé€‰æ‹©ã€‚

## ğŸ¥‡é›†æˆç¤ºä¾‹

âœ¨ä»£ç æ–‡ä»¶ï¼š[middleware-message/rocketmq at master Â· xiaopengooo0/middleware-message](https://github.com/xiaopengooo0/middleware-message/tree/master/rocketmq)

### 1.ä¾èµ–å¼•å…¥

```xml
        <dependency>
            <groupId>org.apache.rocketmq</groupId>
            <artifactId>rocketmq-spring-boot-starter</artifactId>
            <version>2.3.1</version>
        </dependency>
```

### 2.é…ç½®æ–‡ä»¶

```yml
rocketmq:
  name-server: 127.0.0.1:9876
  producer:
    group: rocketmq-group
    send-message-timeout: 3000
    retry-times-when-send-failed: 2
```

### 3. é…ç½®æ³¨å…¥

```java
// äº‹åŠ¡ç›‘å¬å™¨
@RocketMQTransactionListener
public class TransactionListenerImpl implements RocketMQLocalTransactionListener {
    
    @Override
    public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object arg) {
        try {
            // æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
            boolean success = executeBusinessTransaction(msg, arg);
            return success ? RocketMQLocalTransactionState.COMMIT 
                          : RocketMQLocalTransactionState.ROLLBACK;
        } catch (Exception e) {
            return RocketMQLocalTransactionState.UNKNOWN;
        }
    }
    
    @Override
    public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {
        // æ£€æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€
        boolean committed = checkTransactionStatus(msg);
        return committed ? RocketMQLocalTransactionState.COMMIT 
                        : RocketMQLocalTransactionState.ROLLBACK;
    }
    
    private boolean executeBusinessTransaction(Message msg, Object arg) {
        // å®ç°ä¸šåŠ¡äº‹åŠ¡é€»è¾‘
        return true;
    }
    
    private boolean checkTransactionStatus(Message msg) {
        // å®ç°äº‹åŠ¡çŠ¶æ€æ£€æŸ¥é€»è¾‘
        return true;
    }
}
```

### 4.ç”Ÿäº§è€…é…ç½®

```java
@Component
public class RocketMQProducer {

    private static final Logger log = LoggerFactory.getLogger(RocketMQProducer.class);
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    private static final String TOPIC = "user-topic";
    private static final String ORDERLY_TOPIC = "order-topic";
    
    // å‘é€æ™®é€šæ¶ˆæ¯ï¼ˆå¸¦normalæ ‡ç­¾ï¼‰
    public void sendMessage(String message) {
        log.info("ã€RocketMQProducerã€‘å‘é€æ¶ˆæ¯ï¼š{}", message);
        rocketMQTemplate.convertAndSend(TOPIC + ":normal", message);
    }
    
    // å‘é€å¸¦tagçš„æ¶ˆæ¯
    public void sendMessageWithTag(String message) {
        log.info("ã€RocketMQProducerã€‘å‘é€å¸¦tagçš„æ¶ˆæ¯ï¼š{}", message);
        rocketMQTemplate.convertAndSend(TOPIC + ":tagA", message);
    }
    
    // å‘é€é¡ºåºæ¶ˆæ¯
    public void sendOrderlyMessage(String orderId, String message) {
        log.info("ã€RocketMQProducerã€‘å‘é€é¡ºåºæ¶ˆæ¯ï¼š{}", message);
        rocketMQTemplate.syncSendOrderly(ORDERLY_TOPIC, message, orderId);
    }
    
    // å‘é€äº‹åŠ¡æ¶ˆæ¯
    public void sendTransactionMessage(String message, Object arg) {
        TransactionSendResult result = rocketMQTemplate.sendMessageInTransaction(
            TOPIC, 
            MessageBuilder.withPayload(message).build(),
            arg
        );
        log.info("Transaction send result: {}", result.getSendStatus());
    }
}
```

### 5.æ¶ˆè´¹è€…é…ç½®

```java
@Component
public class RocketMQConsumer {

    private static final Logger log = LoggerFactory.getLogger(RocketMQConsumer.class);
    @Service
    // æ™®é€šæ¶ˆè´¹ - åªæ¥æ”¶normalæ ‡ç­¾çš„æ¶ˆæ¯
    @RocketMQMessageListener(
        topic = "user-topic",
        consumerGroup = "common-consumer-group",
        selectorExpression = "normal"
    )
    public static class CommonConsumer implements RocketMQListener<String> {
        @Override
        public void onMessage(String message) {
            log.info("Received normal message: " + message);
        }
    }
    @Service
    // å¸¦tagè¿‡æ»¤çš„æ¶ˆè´¹ - åªæ¥æ”¶tagAæ ‡ç­¾çš„æ¶ˆæ¯
    @RocketMQMessageListener(
        topic = "user-topic",
        selectorExpression = "tagA",
        consumerGroup = "tag-consumer-group"
    )
    public static class TagConsumer implements RocketMQListener<String> {
        @Override
        public void onMessage(String message) {
            log.info("Received tagged message: " + message);
        }
    }
    @Service
    // é¡ºåºæ¶ˆè´¹
    @RocketMQMessageListener(
        topic = "order-topic",
        consumerGroup = "orderly-consumer-group",
        consumeMode = ConsumeMode.ORDERLY
    )
    public static class OrderlyConsumer implements RocketMQListener<String> {
        @Override
        public void onMessage(String message) {
            log.info("Received orderly message: " + message);
        }
    }
```

### 6. æµ‹è¯•æ¶ˆæ¯

```java
@SpringBootTest
@RunWith(SpringRunner.class)
public class ApiTest {

    @Resource
    private RabbitMQProducer rabbitMQProducer;

    @Test
    public void sendMessage() throws InterruptedException {
        rabbitMQProducer.sendDirectMessage("hello rabbitmq");
        rabbitMQProducer.sendTopicMessage("topic.message", "hello top rabbitmq");
        rabbitMQProducer.sendTopicMessage("topic.message.top", "hello top rabbitmq");
        rabbitMQProducer.sendMessageWithConfirm("hello rabbitmq");
        
        // å¢åŠ ç­‰å¾…æ—¶é—´ç¡®ä¿æ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯
        Thread.sleep(10000);
    }
}
```

### è¾“å‡ºç¤ºä¾‹

```powershell
2025-10-31 14:15:03.174  INFO 31272 --- [           main] c.s.m.r.producer.RocketMQProducer        : ã€RocketMQProducerã€‘å‘é€æ¶ˆæ¯ï¼šhello rocketmq
2025-10-31 14:15:03.213  INFO 31272 --- [           main] c.s.m.r.producer.RocketMQProducer        : ã€RocketMQProducerã€‘å‘é€å¸¦tagçš„æ¶ˆæ¯ï¼šhello rocketmq with tag 
2025-10-31 14:15:03.217  INFO 31272 --- [onsumer-group_1] c.s.m.r.consumer.RocketMQConsumer        : Received normal message: hello rocketmq
2025-10-31 14:15:03.217  INFO 31272 --- [           main] c.s.m.r.producer.RocketMQProducer        : ã€RocketMQProducerã€‘å‘é€é¡ºåºæ¶ˆæ¯ï¼šhello rocketmq with orderly
2025-10-31 14:15:03.224  INFO 31272 --- [           main] c.s.m.r.producer.RocketMQProducer        : ã€RocketMQProducerã€‘å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼šhello rocketmq with transaction
2025-10-31 14:15:03.227  INFO 31272 --- [onsumer-group_1] c.s.m.r.consumer.RocketMQConsumer        : Received orderly message: hello rocketmq with orderly
2025-10-31 14:15:03.229  INFO 31272 --- [           main] c.s.m.r.config.TransactionListenerImpl   : ã€TransactionListenerImplã€‘æ¥å—åˆ°äº‹åŠ¡æ¶ˆæ¯ï¼š ----rocketmq with transaction---
2025-10-31 14:15:03.229  INFO 31272 --- [           main] c.s.m.r.config.TransactionListenerImpl   : ã€TransactionListenerImplã€‘æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼š ----rocketmq with transaction---
2025-10-31 14:15:03.407  INFO 31272 --- [onsumer-group_1] c.s.m.r.consumer.RocketMQConsumer        : Received tagged message: hello rocketmq with tag 
```

### docker é…ç½®

`docker-compose.yml`

```yml
version: '3.8'


services:
  # NameServerï¼šRocketMQ çš„æ³¨å†Œä¸­å¿ƒ
  namesrv:
    image: apache/rocketmq:5.3.3
    container_name: rocketmq-namesrv
    ports:
      - "9876:9876"
    command: sh mqnamesrv
    networks:
      - rocketmq-net

  # Brokerï¼šæ¶ˆæ¯æœåŠ¡å™¨ï¼ˆä¸»èŠ‚ç‚¹ï¼‰
  broker:
    image: apache/rocketmq:5.3.3
    container_name: rocketmq-broker
    ports:
      - "10911:10911"   # broker ä¸»ç«¯å£
    environment:
      - JAVA_OPT_EXT=-server -Xms1g -Xmx1g -Xmn512m
    volumes:
      - ./broker.conf:/home/rocketmq/rocketmq-5.1.0/conf/broker.conf
    depends_on:
      - namesrv
    command: >
      sh mqbroker
      -n namesrv:9876
      -c /home/rocketmq/rocketmq-5.1.0/conf/broker.conf
    networks:
      - rocketmq-net

networks:
  rocketmq-net:
    driver: bridge


```

é•œåƒåœ°å€ï¼š`swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/apache/rocketmq:5.3.3-linuxarm64`

`broker.conf`

```properties
# broker åç§°
brokerName = broker-a
brokerId = 0

# NameServer åœ°å€ï¼ˆå®¹å™¨å†…é€šè¿‡æœåŠ¡åè®¿é—®ï¼‰
namesrvAddr = namesrv:9876

# ç›‘å¬åœ°å€ï¼ˆå¿…é¡»è®¾ä¸º 0.0.0.0ï¼Œå¦åˆ™ Docker å¤–éƒ¨æ— æ³•è®¿é—®ï¼‰
brokerIP1 = 0.0.0.0

# Broker å¯¹å¤–æœåŠ¡ç«¯å£
listenPort = 10911

# è‡ªåŠ¨åˆ›å»º Topicï¼ˆå¼€å‘ç¯å¢ƒå»ºè®®å¼€å¯ï¼‰
autoCreateTopicEnable = true

# VIP é€šé“ï¼ˆé€šå¸¸å…³é—­ä»¥é¿å…ç«¯å£å†²çªï¼‰
enableVipChannel = false
```



## ğŸŒŸ RocketMQ äº‹åŠ¡æ¶ˆæ¯çš„æ ¸å¿ƒä¼˜åŠ¿

### âœ… 1. **åŸç”Ÿæ”¯æŒâ€œæœ€ç»ˆä¸€è‡´æ€§â€åˆ†å¸ƒå¼äº‹åŠ¡**

RocketMQ æä¾›äº†ä¸€å¥— **å¯é ã€ç®€æ´ã€é«˜æ€§èƒ½** çš„äº‹åŠ¡æ¶ˆæ¯æ¨¡å‹ï¼Œæ— éœ€ä¾èµ–å¤–éƒ¨åè°ƒå™¨ï¼ˆå¦‚ Seataã€TCC æ¡†æ¶ï¼‰ï¼Œå³å¯å®ç°è·¨æœåŠ¡çš„äº‹åŠ¡ä¸€è‡´æ€§ã€‚

> **å…¸å‹åœºæ™¯**ï¼š
>  ç”¨æˆ·ä¸‹å• â†’ æ‰£å‡åº“å­˜ â†’ åˆ›å»ºè®¢å•
>  è¦æ±‚ï¼š**è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥**

------

### âœ… 2. **åŸºäºâ€œåŠæ¶ˆæ¯ + äº‹åŠ¡çŠ¶æ€å›æŸ¥â€æœºåˆ¶**

RocketMQ çš„äº‹åŠ¡æ¶ˆæ¯é‡‡ç”¨ **ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰æ€æƒ³**ï¼Œä½†åšäº†ä¼˜åŒ–ï¼Œé¿å…é•¿æ—¶é—´é”èµ„æºï¼š

 ğŸ”„ äº‹åŠ¡æ¶ˆæ¯æµç¨‹ï¼š

1. **ç¬¬ä¸€é˜¶æ®µï¼šå‘é€â€œåŠæ¶ˆæ¯â€ï¼ˆHalf Messageï¼‰**
   - Producer å‘ Broker å‘é€ä¸€æ¡ **ä¸å¯è§** çš„æ¶ˆæ¯ï¼ˆæ¶ˆè´¹è€…çœ‹ä¸åˆ°ï¼‰
   - Broker æŒä¹…åŒ–è¯¥æ¶ˆæ¯ï¼Œä½†ä¸æŠ•é€’ç»™ Consumer
2. **æ‰§è¡Œæœ¬åœ°äº‹åŠ¡**
   - Producer æ‰§è¡Œæœ¬åœ°ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ï¼šæ‰£å‡æ•°æ®åº“åº“å­˜ï¼‰
   - æ ¹æ®æ‰§è¡Œç»“æœï¼Œè¿”å›ï¼š
     - `COMMIT`ï¼šæäº¤æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å¯è§
     - `ROLLBACK`ï¼šä¸¢å¼ƒæ¶ˆæ¯
     - `UNKNOWN`ï¼šçŠ¶æ€æœªçŸ¥ï¼ˆå¦‚è¶…æ—¶ã€å¼‚å¸¸ï¼‰
3. **ç¬¬äºŒé˜¶æ®µï¼šBroker ä¸»åŠ¨å›æŸ¥ï¼ˆTransaction Checkï¼‰**
   - å¦‚æœ Producer è¿”å› `UNKNOWN` æˆ–æ— å“åº”ï¼ŒBroker ä¼š**å®šæ—¶å›è°ƒ Producer çš„ `checkLocalTransaction` æ–¹æ³•**
   - Producer æ ¹æ®æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼Œå†æ¬¡è¿”å› `COMMIT` æˆ– `ROLLBACK`
   - æœ€ç»ˆç¡®ä¿æ¶ˆæ¯çŠ¶æ€ä¸æœ¬åœ°äº‹åŠ¡ä¸€è‡´



```java
// ç¤ºä¾‹ï¼šäº‹åŠ¡æ¶ˆæ¯å‘é€
TransactionMQProducer producer = new TransactionMQProducer("my-group");
producer.setTransactionListener(new TransactionListener() {
    @Override
    public LocalTransactionState executeLocalTransaction(Message msg, Object arg) {
        try {
            // 1. æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼ˆå¦‚ï¼šæ›´æ–°DBï¼‰
            boolean success = doBusinessLogic();
            return success ? LocalTransactionState.COMMIT_MESSAGE 
                           : LocalTransactionState.ROLLBACK_MESSAGE;
        } catch (Exception e) {
            return LocalTransactionState.UNKNOW;
        }
    }

    @Override
    public LocalTransactionState checkLocalTransaction(MessageExt msg) {
        // 2. å›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼ˆå¦‚ï¼šæŸ¥DBæ˜¯å¦å·²æäº¤ï¼‰
        boolean committed = queryTransactionStatusFromDB(msg);
        return committed ? LocalTransactionState.COMMIT_MESSAGE 
                         : LocalTransactionState.ROLLBACK_MESSAGE;
    }
});
```

------

### âœ… 3. **é«˜å¯é æ€§ä¿éšœ**

| æœºåˆ¶             | è¯´æ˜                                                         |
| ---------------- | ------------------------------------------------------------ |
| **åŠæ¶ˆæ¯æŒä¹…åŒ–** | å³ä½¿ Producer å´©æºƒï¼ŒBroker ä»ä¿ç•™åŠæ¶ˆæ¯ï¼Œç­‰å¾…å›æŸ¥            |
| **è‡ªåŠ¨é‡è¯•å›æŸ¥** | Broker é»˜è®¤æ¯ 1 åˆ†é’Ÿå›æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤š 15 æ¬¡ï¼ˆå¯é…ç½®ï¼‰           |
| **æ¶ˆæ¯ä¸ä¸¢å¤±**   | ç»“åˆåŒæ­¥åˆ·ç›˜ + ä¸»ä»å¤åˆ¶ï¼Œç¡®ä¿äº‹åŠ¡æ¶ˆæ¯ 100% å¯é               |
| **å¹‚ç­‰æ¶ˆè´¹**     | æ¶ˆè´¹è€…éœ€è‡ªè¡Œå®ç°å¹‚ç­‰ï¼Œä½† RocketMQ æä¾›æ¶ˆæ¯ IDï¼ˆ`msgId`ï¼‰ä¾¿äºå»é‡ |

------

### âœ… 4. **æ€§èƒ½ä¸è§£è€¦å…¼é¡¾**

- **å¼‚æ­¥æäº¤**ï¼šæœ¬åœ°äº‹åŠ¡æ‰§è¡Œå®Œå³å¯è¿”å›ï¼Œæ— éœ€ç­‰å¾…æ¶ˆè´¹è€…å¤„ç†
- **æ— ä¸­å¿ƒåè°ƒå™¨**ï¼šé¿å… Seata/TCC çš„å…¨å±€é”å’Œæ€§èƒ½ç“¶é¢ˆ
- **ä½ä¾µå…¥**ï¼šä¸šåŠ¡ä»£ç åªéœ€å®ç°ä¸¤ä¸ªå›è°ƒæ–¹æ³•ï¼Œæ— éœ€æ”¹é€ æ•°æ®åº“

> ğŸ’¡ ç›¸æ¯”ä¼ ç»Ÿ 2PCï¼ˆå¦‚ XAï¼‰ï¼ŒRocketMQ äº‹åŠ¡æ¶ˆæ¯ï¼š
>
> - ä¸é”å®šæ•°æ®åº“èµ„æº
> - ä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡æ—¥å¿—
> - æ›´é€‚åˆé«˜å¹¶å‘åœºæ™¯

## ğŸ¦ å…¸å‹é‡‘èåœºæ™¯ç¤ºä¾‹

**åœºæ™¯ï¼šç”¨æˆ·è½¬è´¦**

1. A è´¦æˆ·æ‰£æ¬¾ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
2. å‘é€äº‹åŠ¡æ¶ˆæ¯åˆ° MQ
3. B è´¦æˆ·åŠ æ¬¾ï¼ˆæ¶ˆè´¹è€…å¤„ç†ï¼‰

âœ… **ä¸€è‡´æ€§ä¿è¯**ï¼š

- è‹¥ A æ‰£æ¬¾å¤±è´¥ â†’ æ¶ˆæ¯å›æ»šï¼ŒB ä¸åŠ æ¬¾
- è‹¥ A æ‰£æ¬¾æˆåŠŸä½†æ¶ˆæ¯å‘é€å¤±è´¥ â†’ Broker å›æŸ¥å‘ç° A å·²æ‰£æ¬¾ â†’ è¡¥å‘æ¶ˆæ¯ â†’ B åŠ æ¬¾
- è‹¥ B æ¶ˆè´¹å¤±è´¥ â†’ æ¶ˆæ¯é‡è¯•ï¼Œç›´åˆ°æˆåŠŸï¼ˆé…åˆæ­»ä¿¡é˜Ÿåˆ—å…œåº•ï¼‰

------

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¶ˆè´¹è€…å¿…é¡»å¹‚ç­‰**ï¼šå› ä¸ºæ¶ˆæ¯å¯èƒ½é‡å¤æŠ•é€’
2. **å›æŸ¥æ¥å£è¦è½»é‡**ï¼šé¿å…é˜»å¡ Broker çº¿ç¨‹
3. **åˆç†è®¾ç½®å›æŸ¥æ¬¡æ•°å’Œé—´éš”**ï¼šé¿å…æ— é™é‡è¯•
4. **ç›‘æ§äº‹åŠ¡çŠ¶æ€**ï¼šåŠæ—¶å‘ç°é•¿æ—¶é—´ `UNKNOWN` çš„æ¶ˆæ¯

------

## âœ… æ€»ç»“ï¼šRocketMQ åœ¨äº‹åŠ¡å¤„ç†ä¸Šçš„æ ¸å¿ƒä¼˜åŠ¿

> **â€œç”¨æ¶ˆæ¯ä¸­é—´ä»¶çš„èƒ½åŠ›ï¼Œä¼˜é›…è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡éš¾é¢˜â€**

| ä¼˜åŠ¿                  | ä»·å€¼                               |
| --------------------- | ---------------------------------- |
| **åŸç”Ÿäº‹åŠ¡æ¶ˆæ¯æ”¯æŒ**  | å¼€ç®±å³ç”¨ï¼Œæ— éœ€å¼•å…¥é¢å¤–æ¡†æ¶         |
| **åŠæ¶ˆæ¯ + å›æŸ¥æœºåˆ¶** | ä¿è¯æœ¬åœ°äº‹åŠ¡ä¸æ¶ˆæ¯å‘é€çš„æœ€ç»ˆä¸€è‡´æ€§ |
| **é«˜å¯é ã€é«˜å¯ç”¨**    | é‡‘èçº§ SLAï¼Œæ¶ˆæ¯é›¶ä¸¢å¤±             |
| **é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿ**    | é€‚åˆé«˜å¹¶å‘äº¤æ˜“åœºæ™¯                 |
| **æ¶æ„ç®€æ´ã€æ˜“ç»´æŠ¤**  | é™ä½ç³»ç»Ÿå¤æ‚åº¦å’Œè¿ç»´æˆæœ¬           |

å› æ­¤ï¼Œåœ¨éœ€è¦ **å¼ºä¸€è‡´æ€§ã€é«˜å¯é ã€äº‹åŠ¡ä¿éšœ** çš„ä¸šåŠ¡ä¸­ï¼ˆå¦‚æ”¯ä»˜ã€è®¢å•ã€è´¦åŠ¡ï¼‰ï¼Œ**RocketMQ æ˜¯ç›®å‰æœ€æˆç†Ÿã€æœ€å®ç”¨çš„æ¶ˆæ¯ä¸­é—´ä»¶é€‰æ‹©ä¹‹ä¸€**ã€‚